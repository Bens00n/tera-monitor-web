{% extends "layout.html" %}
{% block content %}

<div class="d-flex align-items-center gap-3 flex-wrap">
  <h3 class="mb-0">
    Status serwera:
    <span id="status_text" class="{% if status_text=='ONLINE' %}status-online{% else %}status-offline{% endif %}">
      {% if status_text=='ONLINE' %}
        <i class="bi bi-check-circle-fill me-1"></i> ONLINE
      {% else %}
        <i class="bi bi-x-circle-fill me-1"></i> OFFLINE
      {% endif %}
    </span>
  </h3>
  <span class="small-muted">Ostatnia zmiana: <span id="last_change">{{ last_change_local or '-' }}</span></span>
  <div class="ms-auto d-flex gap-2">
    <a href="{{ url_for('notify_test') }}" class="btn-tera btn-sm"><i class="bi bi-bell-fill me-1"></i>Test push</a>
    <a href="{{ url_for('export_db') }}" class="btn btn-ghost btn-sm"><i class="bi bi-hdd-stack me-1"></i>DB</a>
  </div>
</div>

<h4 class="mt-3">
  Graczy online: <span id="players">{{ players if players is not none else "?" }}</span>
  <span class="badge-tera ms-2"><i class="bi bi-trophy me-1"></i>Rekord: <span id="peak_players">{{ peak_players if peak_players is not none else "-" }}</span></span>
</h4>

<div class="row g-4 mt-1 align-items-start">
  <div class="col-auto spark-wrap">
    <img class="spark" id="spark_players" src="{{ url_for('spark_players') }}?ts={{cache_bust}}" alt="spark players"/>
    <div class="sparkcap"><i class="bi bi-people-fill me-1"></i>Players – 60 min</div>
  </div>
  <div class="col-auto spark-wrap">
    <img class="spark" id="spark_ping" src="{{ url_for('spark_ping') }}?ts={{cache_bust}}" alt="spark ping"/>
    <div class="sparkcap"><i class="bi bi-wifi me-1"></i>Ping – 60 min</div>
  </div>
  <div class="col flex-grow-1">
    <div class="fw-semibold"><i class="bi bi-wifi me-1"></i>Ping:</div>
    <div>
      min <span id="min_ping">{{ min_ping if min_ping is not none else "-" }}</span> /
      avg <span id="avg_ping">{{ avg_ping if avg_ping is not none else "-" }}</span> /
      max <span id="max_ping">{{ max_ping if max_ping is not none else "-" }}</span> ms
    </div>
  </div>
</div>

<div class="row row-cols-1 row-cols-md-3 g-3 mt-3">
  <div class="col">
    <div class="tera-window">
      <div class="tera-header">Uptime (ONLINE)</div>
      <div class="tera-body">
        <div class="display-6" id="uptime">-</div>
        <div class="small-muted">
          Rekord: <span id="record_uptime">-</span> | Najkrótszy: <span id="record_min_uptime">-</span>
        </div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="tera-window">
      <div class="tera-header">Downtime (OFFLINE)</div>
      <div class="tera-body">
        <div class="display-6" id="downtime">-</div>
        <div class="small-muted">
          Rekord: <span id="record_downtime">-</span> | Najkrótszy: <span id="record_min_downtime">-</span>
        </div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="tera-window">
      <div class="tera-header">Zdarzenia</div>
      <div class="tera-body"><div id="events" class="small"></div></div>
    </div>
  </div>
</div>

<hr />
<div class="d-flex align-items-center justify-content-between">
  <h5><i class="bi bi-graph-up me-1"></i>Players online</h5>
  <div class="d-flex gap-2">
    <a class="btn btn-ghost btn-sm" href="{{ url_for('report_csv') }}"><i class="bi bi-download me-1"></i>SLA CSV</a>
    <a class="btn btn-ghost btn-sm" href="{{ url_for('export_players_csv') }}"><i class="bi bi-download me-1"></i>Players CSV</a>
    <a class="btn btn-ghost btn-sm" href="{{ url_for('export_ping_csv') }}"><i class="bi bi-download me-1"></i>Ping CSV</a>
  </div>
</div>
<div class="row g-3">
  <div class="col-md-4 text-center">
    <img src="{{ url_for('plot_players', minutes=60) }}?ts={{cache_bust}}" class="img-fluid" alt="1h players" />
    <div class="mt-1 small-muted">1h</div>
  </div>
  <div class="col-md-4 text-center">
    <img src="{{ url_for('plot_players', minutes=180) }}?ts={{cache_bust}}" class="img-fluid" alt="3h players" />
    <div class="mt-1 small-muted">3h</div>
  </div>
  <div class="col-md-4 text-center">
    <img src="{{ url_for('plot_players', minutes=360) }}?ts={{cache_bust}}" class="img-fluid" alt="6h players" />
    <div class="mt-1 small-muted">6h</div>
  </div>
</div>

<hr />
<h5><i class="bi bi-sliders me-1"></i>Ustawienia</h5>
<form id="settingsForm" class="row g-2">
  <div class="col-md-2">
    <label class="form-label">Mute włączony</label>
    <select class="form-select form-select-sm" name="mute_enabled">
      <option value="0" {{ 'selected' if not cfg.mute_enabled else '' }}>Nie</option>
      <option value="1" {{ 'selected' if cfg.mute_enabled else '' }}>Tak</option>
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">Ciche od</label>
    <input class="form-control form-control-sm" type="time" name="quiet_start" value="{{ cfg.quiet_start }}">
  </div>
  <div class="col-md-2">
    <label class="form-label">Ciche do</label>
    <input class="form-control form-control-sm" type="time" name="quiet_end" value="{{ cfg.quiet_end }}">
  </div>
  <div class="col-md-2">
    <label class="form-label">Ping alert (ms)</label>
    <input class="form-control form-control-sm" type="number" name="ping_alert_ms" value="{{ cfg.ping_alert_ms }}">
  </div>
  <div class="col-md-2">
    <label class="form-label">GLITCH (s)</label>
    <input class="form-control form-control-sm" type="number" name="glitch_seconds" value="{{ cfg.glitch_seconds }}">
  </div>
  <div class="col-md-2 d-flex align-items-end">
    <button class="btn-tera btn-sm w-100"><i class="bi bi-save2 me-1"></i>Zapisz</button>
  </div>
</form>

<script>
  function fmtDuration(s){
    if(!s || s<0) return "-";
    const d=Math.floor(s/86400); s%=86400;
    const h=Math.floor(s/3600); s%=3600;
    const m=Math.floor(s/60); const sec=Math.floor(s%60);
    return (d>0?(d+"d "):"")+String(h).padStart(2,'0')+":"+String(m).padStart(2,'0')+":"+String(sec).padStart(2,'0');
  }
  function renderSummary(j){
    const st=document.getElementById('status_text');
    st.classList.remove('status-online','status-offline');
    st.classList.add(j.status_text==='ONLINE'?'status-online':'status-offline');
    st.innerHTML=(j.status_text==='ONLINE'
      ? '<i class="bi bi-check-circle-fill me-1"></i>ONLINE'
      : '<i class="bi bi-x-circle-fill me-1"></i>OFFLINE');

    document.getElementById('players').textContent=(j.players ?? "?");
    document.getElementById('peak_players').textContent=(j.peak_players ?? "-");
    document.getElementById('last_change').textContent=j.last_change_local || "-";

    document.getElementById('min_ping').textContent=(j.min_ping ?? "-");
    document.getElementById('avg_ping').textContent=(j.avg_ping ?? "-");
    document.getElementById('max_ping').textContent=(j.max_ping ?? "-");

    document.getElementById('uptime').textContent=j.uptime_counting ? fmtDuration(j.uptime_seconds) : "-";
    document.getElementById('downtime').textContent=j.downtime_counting ? fmtDuration(j.downtime_seconds) : "-";
    document.getElementById('record_uptime').textContent=j.record_uptime_seconds ? fmtDuration(j.record_uptime_seconds) : "-";
    document.getElementById('record_downtime').textContent=j.record_downtime_seconds ? fmtDuration(j.record_downtime_seconds) : "-";
    document.getElementById('record_min_uptime').textContent=j.record_min_uptime_seconds ? fmtDuration(j.record_min_uptime_seconds) : "-";
    document.getElementById('record_min_downtime').textContent=j.record_min_downtime_seconds ? fmtDuration(j.record_min_downtime_seconds) : "-";

    // sparki + wykresy odśwież
    document.getElementById('spark_players').src="/spark/players?ts="+Date.now();
    document.getElementById('spark_ping').src="/spark/ping?ts="+Date.now();
    document.querySelectorAll('img[alt$=\"players\"], img[alt$=\"ping\"]').forEach(img=>{
      const base = img.getAttribute('src').split('?')[0];
      img.src = base + '?ts=' + Date.now();
    });
  }
  async function refreshSummary(){
    try{
      const r = await fetch('/api/summary'); renderSummary(await r.json());
    }catch(e){ console.warn(e); }
  }
  async function refreshEvents(){
    try{
      const r=await fetch('/api/events?limit=50');
      const list=await r.json();
      const box=document.getElementById('events'); box.innerHTML='';
      list.reverse().forEach(e=>{
        const row=document.createElement('div');
        row.textContent=`[${e.ts}] ${e.kind}: ${e.msg}`;
        box.prepend(row);
      });
    }catch(e){}
  }
  refreshSummary(); refreshEvents();
  setInterval(refreshSummary, 5000);
  setInterval(refreshEvents, 10000);

  document.getElementById('settingsForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const fd=new FormData(ev.target);
    const data=Object.fromEntries(fd.entries());
    data.mute_enabled = data.mute_enabled==="1";
    const r=await fetch('/api/settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    alert(r.ok?'Zapisano.':'Błąd zapisu');
  });
</script>
{% endblock %}
